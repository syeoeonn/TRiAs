# TRiAs

**TRiAs** (Tandem Repeat identification from Assemblies) is a toolkit for 
extracting and analyzing tandem repeat alleles from genome assemblies.

---

## Overview

TRiAs provides the following subcommands:

- `bed-prepare`   : Prepare TR interval BED files
- `vcf-alleles`   : Extract population TR alleles from VCF
- `motif-count`   : Count motif repeats
- `motif-summary` : Summarize motif counts across groups
- `dntre`         : Parallel *de novo* TRE caller


General usage:

```bash
trias <subcommand> [options]
```

Show help:

```bash
trias -h
trias <subcommand> -h
```

---

## Installation

```bash
pip install trias
```

---
## 1. bed-prepare

Generate per-chromosome TR locus tables from an input TR BED file and a reference FASTA.

The output includes genomic coordinates, motif sequence(s), and the reference TR allele sequence, forming the basis for downstream TR allele extraction and dnTRE analysis.


### Usage

```bash
trias bed-prepare --bed GRCh38.bed.gz --fasta GRCh38.fa --outdir GRCh38
```

### Required arguments

- `--bed` : Input BED file (.bed or .bed.gz) describing TR loci.  
  Required columns:
  1. Chromosome  
  2. Start (0-based)  
  3. End  
  4. Motif sequence (default column index: 10; configurable via `--motif-col`)  

- `--fasta` : Reference FASTA file corresponding to the BED coordinates.
- `--outdir` : Output directory

### Optional arguments

- `--threads` (default: 4)
- `--chunk` (default: 1000)
- `--motif-col` (default: 10; 1-based index)
- `--has-header` : Skip first BED line if header exists

### Example Output 

The output is required for downstream analyses because TR-based workflows depend on:
- Reference genome TR region coordinates
- Motif sequence(s) at each locus
- The actual reference allele sequence within that region


```text
CHROM   START   END     MOTIF   TR_allele
chr17   37896819        37896944        AAATG,AAATA     AAATAAAATGAAATGAAATGAAATGAAATGAAATGAAATAATGAAATGAAATGAAATGAAATGAAATGAAATGAAATAAAATAAAATAAAATAAAATAAAATAATAAAATAAAATAAAATAAAAT
```

---

## 2. vcf-alleles

Extract TR alleles for each sample and summarize them by population-defined groups using a **multi-sample, multi-allelic VCF**.

This step uses population-level variant information to reconstruct TR alleles per locus and reports allele sequences grouped by user-defined sample sets.

It enables comparison of TR variation across reference, control, and case populations.

Note: TR loci with no variant calls across all samples (i.e., identical to the reference in the VCF) are not reported in the output.

### Usage

```bash
trias vcf-alleles \
    --vcf input.vcf.gz --input ${CHROM}.bed --output TR_population_${CHROM}.tsv \
    --groups GRCh38.tsv HPRC.tsv Unaffected.tsv Affected.tsv
```

### Required arguments

- `--vcf` : Indexed multi-sample, multi-allelic VCF (`.vcf.gz` with `.tbi` or `.csi`). For example, VCFs generated from the **minigraph-cactus pangenome pipeline** are supported.
- `--input` : TR loci TSV generated by `bed-prepare`, containing columns:  `CHROM, START, END, MOTIF, TR_allele`
- `--output` : Output TSV path
- `--groups` : One or more group TSV files  
  - The FIRST file is treated as the reference group  
  - Format per line: `sample_name<TAB>ploidy`

### Optional arguments

- `--processes` (default: 32)
- `--chunk-size` (default: 10000)
- `--tmpdir` (default: ./tmp)

### Example Output 

The output is a tab-separated (TSV) file summarizing TR alleles across population-defined groups.
- `GRCh38`, `HPRC`, `Unaffected`, `Affected` :  
  Number of haplotypes within each group carrying the corresponding TR allele.
- `Samples` :  
  Comma-separated list of sample.haplotype identifiers carrying the allele.


```text
GRCh38  HPRC    Unaffected      Affected        CHROM   START   END     MOTIF   TR_allele       Samples
0       1       0       0       chr17   37896819        37896944        AAATG,AAATA     AAATAAAATAAAATAAAATAAAATAAAATAAAATAAAATAAAAT    HG02818.1
0       4       0       0       chr17   37896819        37896944        AAATG,AAATA     AAATAAAATAAAATAAAATAAAATAAAATAAAATAAAATAAAATAAAAT       HG02717.1,HG02723.1,HG03579.1,NA19240.1
0       2       2       0       chr17   37896819        37896944        AAATG,AAATA     AAATAAAATAAAATAAAATAAAATAAAATAAAATAAAATAAAATAAAATAAAAT  HG00438.1,HG02559.2,SAMPLE3.2,SAMPLE2.2
0       24      8       4       chr17   37896819        37896944        AAATG,AAATA     AAATAAAATAAAATAAAATAAAATAAAATAAAATAAAATAAAATAAAATAAAATAAAAT     HG00438.2,HG005.1,HG005.2,HG00621.1,HG00621.2,HG00673.1,HG00735.1,HG01106.2,HG01123.1,...
0       0       1       0       chr17   37896819        37896944        AAATG,AAATA     AAATAAAATGAAATAAAATAAAATGAAATAAAATGAAATAAAATAAAATAAAATAAAAT     SAMPLE3.1
1       27      5       2       chr17   37896819        37896944        AAATG,AAATA     AAATAAAATGAAATGAAATGAAATGAAATGAAATGAAATAATGAAATGAAATGAAATGAAATGAAATGAAATGAAATAAAATAAAATAAAATAAAATAAAATAATAAAATAAAATAAAATAAAAT   GRCh38,+HG02818.2+,...
...
```

⚠️ **Special notation in `Samples` column**

If a sample name is enclosed with `+` symbols (e.g., `+HG02818.2+`),  
it indicates that the variant at this locus was **not called in the VCF ('.')** for that sample.

In such cases, TRiAs assumes the sample carries the **reference allele sequence**,  
and the allele is reconstructed accordingly. The `+` markers are added to explicitly denote this assumption.

---

## 3. motif-count

Count per-motif repeat structure from reconstructed TR alleles.

This step summarizes repeat architecture for each allele by identifying **consecutive motif blocks** and **total motif counts**.  

### Usage

```bash
trias motif-count \
  --input TR_population_${CHROM}.tsv --output TR_population_${CHROM}_mc.tsv
```

### Required arguments

- `--input`: Output TSV generated by `vcf-alleles`
- `--output`: Output TSV with motif repeat statistics

### Optional arguments

- `--max-workers` (default: 100)
- `--group-chunk-size` (default: 8000)

### Example Output 

The output extends the `vcf-alleles` table by adding motif repeat statistics.


```text
GRCh38  CHM13   HPRC    Unaffected      Affected        CHROM   START   END     MOTIF   TR_allele       max_consec_dna  total_repeat_dna        Samples
0       1       0       0       chr17   37896819        37896944        AAATG,AAATA     (AAATA)8AAAT    0_8     0_8     HG02818.1
0       4       0       0       chr17   37896819        37896944        AAATG,AAATA     (AAATA)9AAAT    0_9     0_9     HG02717.1,HG02723.1,HG03579.1,NA19240.1
0       2       2       0       chr17   37896819        37896944        AAATG,AAATA     (AAATA)10AAAT   0_10    0_10    HG00438.1,HG02559.2,SAMPLE1.2,SAMPLE2.2
0       24      8       4       chr17   37896819        37896944        AAATG,AAATA     (AAATA)11AAAT   0_11    0_11    HG00438.2,HG005.1,HG005.2,HG00621.1,HG00621.2,HG00673.1,HG00735.1,HG01106.2,HG01123.1,...
0       0       1       0       chr17   37896819        37896944        AAATG,AAATA     (AAATA)(AAATG)(AAATA)2(AAATG)(AAATA)(AAATG)(AAATA)4AAAT 1_4     3_8     SAMPLE1.1
1       27      5       2       chr17   37896819        37896944        AAATG,AAATA     (AAATA)(AAATG)6(AAATA)ATG(AAATG)6(AAATA)6ATA(AAATA)3AAAT        6_6     12_11   GRCh38,+HG02818.2+,...
...
```
- `max_consec_dna` :  
  Maximum number of consecutive repeats observed for each motif within the allele sequence.

- `total_repeat_dna` :  
  Total number of repeats (sum across the allele) for each motif.

- If multiple motifs are defined for a TR locus, their counts are reported in motif order and separated by `_`.  
For example:

    - `0_11` → motif1 count = 0, motif2 count = 11  
    - `6_6` → motif1 count = 6, motif2 count = 6 

---

## 4. motif-summary

Summarize motif repeat statistics per TR locus across population and custom-defined groups.

This step aggregates repeat count metrics (range and mean) for each group and TR locus.  
The resulting statistics serve as a quantitative baseline for downstream dnTRE detection,  
where expansion is evaluated relative to population-level repeat distributions.


### Usage

```bash
trias motif-summary \
  --input TR_population_${CHROM}_mc.tsv --output ${CHROM}_summary.tsv \
  --groups Unaffected.txt --groups Our.txt
```

### Optional arguments

- `--groups` : Text file listing column names for a group  
  (multiple `--groups` allowed)
- `--processes` (default: CPU count)
- `--chunk-size` (default: auto)

### Example Output 

For each TR locus, motif-summary reports:
- Allele counts per group
- Range of repeat counts (min–max)
- Mean repeat count
- Range and mean for both:
  - `total_repeat_dna`
  - `max_consec_dna`

```text
Population_allele_count Our_allele_count        Unaffected_allele_count CHROM   START   END     MOTIF   Population_total_repeat_dna_range       Population_max_consec_dna_range    Population_total_repeat_dna_mean        Population_max_consec_dna_mean  Unaffected_total_repeat_dna_range       Unaffected_max_consec_dna_range Unaffected_total_repeat_dna_mean   Unaffected_max_consec_dna_mean  Our_total_repeat_dna_range      Our_max_consec_dna_range        Our_total_repeat_dna_mean       Our_max_consec_dna_mean
126     10      116     chr17   37896819        37896944        AAATG,AAATA     0-17_6-18       0-10_3-18       6.06_11.17      3.23_8.49       0-15_6-18       0-9_3-18   6.05_11.27      3.22_8.53       0-17_7-12       0-10_4-12       6.10_10.10      3.30_8.10
```

If multiple motifs are present at a locus, values are reported in motif order and separated by `_`.

Example interpretation:

- `0-17_6-18`  
  → Motif1 range: 0–17  
  → Motif2 range: 6–18  

- `6.06_11.17`  
  → Motif1 mean: 6.06  
  → Motif2 mean: 11.17 

⚠️ **Group definitions**

- `Population_*` columns are always generated and represent statistics calculated across **all samples present in the input file**, regardless of custom group definitions.

- Additional group columns (e.g., `Unaffected_*`, `Our_*`) are derived from user-provided `--groups` files.  
  Each `--groups` file defines a custom subset of samples to be summarized independently.

For example:

```text
cat Unaffected.txt
GRCh38
HPRC
Unaffected
```

In this case, the `Unaffected_*` columns summarize repeat statistics across only those listed sample groups.  
Similarly, `Our_*` columns are computed using the sample names provided in `Our.txt`.


---

## 5. dntre

Parallel *de novo* tandem repeat expansion (dnTRE) caller.

Unlike previous steps that are typically performed per chromosome,  
`dntre` operates on the **combined genome-wide summary files** generated from all chromosomes.  
It integrates locus-level statistics and per-allele repeat structures to identify candidate dnTRE events.

This step evaluates repeat expansion in case samples relative to control and population distributions.


### Usage

```bash
trias dntre \
  --loci /path/chr*_summary.tsv \
  --alleles /path/TR_population_chr*_mc.tsv \
  --case Affected \
  --control GRCh38,HPRC,Unaffected \
  --loci-case-prefix Our \
  --loci-control-prefix Unaffected \
  --trio ../trios.tsv \
  --hap1-label maternal --hap2-label paternal \
  --threshold 2.0
```

### Required arguments

- `--loci` : Genome-wide TR summary TSV files (e.g., `*_summary.tsv`, can use glob)
- `--alleles` : Genome-wide per-allele motif-count TSV files (e.g., `*_mc.tsv`)
- `--case` : Case column name(s), comma-separated
- `--control` : Control column name(s), comma-separated

### Important optional parameters

- `--threshold` (default: 1.0)  
  Minimum motif-specific motif count (MC) ratio required for expansion.

- `--min-pop-mean` (default: 1.0)  
  Minimum population mean motif count required for ratio calculation.

- `--trio` : Trio TSV (`child<TAB>father<TAB>mother`)
    ```text
    child      father        mother
    SAMPLE1    SAMPLE1_F     SAMPLE1_M
    ```
- `--hap1-label` (default: haplotype1)
- `--hap2-label` (default: haplotype2)
- `--jobs` (default: CPU count)
- `--tmpdir` (default: ./_dntre_tmp)
- `--keep-temp`

---

### dnTRE Filtering Logic

An expansion index (MC ratio) is calculated for every allele as:

$$(count_{case} - \overline{count}_{population}) / \overline{count}_{population}$$    

An index of **1** denotes a two-fold expansion relative to controls  
(i.e., the allele has twice the repeat count compared to the population mean baseline).


A TR locus is reported as a candidate dnTRE if:

1. **Case maximum repeat count exceeds control maximum repeat count**,  
   and population mean repeat count ≥ 1.

2. In the case allele, at least one motif index has  
   **MC ratio > threshold**.

3. For all control alleles, all motif indices satisfy  
   **MC ratio ≤ threshold**.

This multi-level filtering ensures that detected events represent case-specific expansions beyond population variation.

---

### Example Output 

- `dnTRE.tsv`  
  Per-allele dnTRE calls.
    ```text
    Chrom   Start   End     Motifs  dnTRE_total     dnTRE_max       dnTRE_total_MC  dnTRE_max_MC    Population_total_mean   Population_max_mean     Allele_origin   motif_index_total_dna       motif_index_max_consec  Father_IDs      Mother_IDs      Child_ID        Father_total_count      Father_max_count        Mother_total_count      Mother_max_count    Child_total_count       Child_max_count Child_total_MCratio     Child_max_MCratio
    chr17   37896819        37896944        AAATG,AAATA     N       Y       17_7    10_4    6.06_11.17      3.23_8.49       maternal        -       0       SAMPLE1_F    SAMPLE1_M        SAMPLE1    0_11,12_11      0_11,6_6        0_11,0_11       0_11,0_11       17_7,17_7       10_4,10_4       1.81_-0.37      2.10_-0.53
    chr17   37896819        37896944        AAATG,AAATA     N       Y       17_7    10_4    6.06_11.17      3.23_8.49       paternal        -       0       SAMPLE1_F    SAMPLE1_M        SAMPLE1    0_11,12_11      0_11,6_6        0_11,0_11       0_11,0_11       17_7,17_7       10_4,10_4       1.81_-0.37      2.10_-0.53
    ```

- `dnTRE_loci.tsv`  
  Loci that contain at least one dnTRE event.
  ```text
  Chrom   Start   End     Motifs  dnTRE_total     dnTRE_max       Population_total_mean   Population_max_mean     motif_index_total_dna   motif_index_max_consec
  chr17   37896819        37896944        AAATG,AAATA     N       Y       6.06_11.17      3.23_8.49       -       0
  ```

- `all_alleles_in_dnTRE_loci.tsv`  
  All alleles observed in dnTRE loci.

---

